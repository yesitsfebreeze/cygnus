// Copyright 2021 Manna Harbour
// https://github.com/manna-harbour/miryoku
// Miryoku layout adapted for Cygnus

#include <behaviors/mouse_keys.dtsi>
#include <dt-bindings/zmk/mouse.h>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/pointing.h>

#define TAPPING_TERM 200

// Mouse settings
#define MOUSE_MOVE_EXPONENT 1
#define MOUSE_MOVE_TIME 1500
#define MOUSE_MOVE_DELAY 0
#define MOUSE_SCROLL_EXPONENT 1
#define MOUSE_SCROLL_TIME 5000
#define MOUSE_SCROLL_DELAY 0

// Layer definitions

#define L01 0
#define L02 1
#define L03 2
#define L04 3
#define L05 4
#define L06 5
#define L07 6
#define L08 7
#define L09 8
#define L10 9

// Mouse movement configuration
&mmv {
	acceleration-exponent = <MOUSE_MOVE_EXPONENT>;
	time-to-max-speed-ms = <MOUSE_MOVE_TIME>;
	delay-ms = <MOUSE_MOVE_DELAY>;
};

&msc {
	acceleration-exponent = <MOUSE_SCROLL_EXPONENT>;
	time-to-max-speed-ms = <MOUSE_SCROLL_TIME>;
	delay-ms = <MOUSE_SCROLL_DELAY>;
};

/ {
	macros {
		// Bluetooth select with clear on shift
		u_macro_bt_sel_0: u_macro_bt_sel_0 {
			compatible = "zmk,behavior-macro";
			#binding-cells = <0>;
			wait-ms = <0>;
			tap-ms = <0>;
			bindings = <&bt BT_SEL 0 &bt BT_CLR>;
		};
		u_macro_bt_sel_1: u_macro_bt_sel_1 {
			compatible = "zmk,behavior-macro";
			#binding-cells = <0>;
			wait-ms = <0>;
			tap-ms = <0>;
			bindings = <&bt BT_SEL 1 &bt BT_CLR>;
		};
		u_macro_bt_sel_2: u_macro_bt_sel_2 {
			compatible = "zmk,behavior-macro";
			#binding-cells = <0>;
			wait-ms = <0>;
			tap-ms = <0>;
			bindings = <&bt BT_SEL 2 &bt BT_CLR>;
		};
		u_macro_bt_sel_3: u_macro_bt_sel_3 {
			compatible = "zmk,behavior-macro";
			#binding-cells = <0>;
			wait-ms = <0>;
			tap-ms = <0>;
			bindings = <&bt BT_SEL 3 &bt BT_CLR>;
		};
	};

	behaviors {
		mt: mt {
			compatible = "zmk,behavior-hold-tap";
			#binding-cells = <2>;
			tapping-term-ms = <TAPPING_TERM>;
			flavor = "tap-preferred";
			bindings = <&kp>, <&kp>;
		};

		lt: lt {
			compatible = "zmk,behavior-hold-tap";
			#binding-cells = <2>;
			tapping-term-ms = <TAPPING_TERM>;
			flavor = "tap-preferred";
			bindings = <&mo>, <&kp>;
		};

		sp: sp {
			compatible = "zmk,behavior-mod-morph";
			#binding-cells = <2>;
			bindings = <&kp>, <&kp>;
			mods = <(MOD_LSFT|MOD_RSFT)>;
		};

		// Bluetooth select behaviors with shift-to-clear
		u_bt_sel_0: u_bt_sel_0 {
			compatible = "zmk,behavior-mod-morph";
			#binding-cells = <0>;
			bindings = <&bt BT_SEL 0>, <&u_macro_bt_sel_0>;
			mods = <(MOD_LSFT|MOD_RSFT)>;
		};
		u_bt_sel_1: u_bt_sel_1 {
			compatible = "zmk,behavior-mod-morph";
			#binding-cells = <0>;
			bindings = <&bt BT_SEL 1>, <&u_macro_bt_sel_1>;
			mods = <(MOD_LSFT|MOD_RSFT)>;
		};
		u_bt_sel_2: u_bt_sel_2 {
			compatible = "zmk,behavior-mod-morph";
			#binding-cells = <0>;
			bindings = <&bt BT_SEL 2>, <&u_macro_bt_sel_2>;
			mods = <(MOD_LSFT|MOD_RSFT)>;
		};
		u_bt_sel_3: u_bt_sel_3 {
			compatible = "zmk,behavior-mod-morph";
			#binding-cells = <0>;
			bindings = <&bt BT_SEL 3>, <&u_macro_bt_sel_3>;
			mods = <(MOD_LSFT|MOD_RSFT)>;
		};

		// Output toggle with shift-to-usb
		u_out_tog: u_out_tog {
			compatible = "zmk,behavior-mod-morph";
			#binding-cells = <0>;
			bindings = <&out OUT_TOG>, <&out OUT_USB>;
			mods = <(MOD_LSFT|MOD_RSFT)>;
		};

		// Caps word with shift-to-capslock
		u_caps_word: u_caps_word {
			compatible = "zmk,behavior-mod-morph";
			#binding-cells = <0>;
			bindings = <&caps_word>, <&kp CAPS>;
			mods = <(MOD_LSFT|MOD_RSFT)>;
		};

		// Double-tap guards for layer switching
		u_to_L01: u_to_L01 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L01>;
		};
		u_to_L02: u_to_L02 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L02>;
		};
		u_to_L03: u_to_L03 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L03>;
		};
		u_to_L04: u_to_L04 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L04>;
		};
		u_to_L0 5: u_to_L0 5 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L0 5>;
		};
		u_to_L06: u_to_L06 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L06>;
		};
		u_to_L07: u_to_L07 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L07>;
		};
		u_to_L08: u_to_L08 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L08>;
		};
		u_to_SYM_L: u_to_SYM_L {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L09>;
		};
		u_to_L10: u_to_L10 {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&to L10>;
		};

		// Double-tap bootloader
		u_bootloader: u_bootloader {
			compatible = "zmk,behavior-tap-dance";
			#binding-cells = <0>;
			tapping-term-ms = <TAPPING_TERM>;
			bindings = <&none>, <&bootloader>;
		};
	};

	keymap {
		compatible = "zmk,keymap";


// ESC  L    W    B    Y        J    F    U    O    BSP
// A    R    S    T    G        M    N    E    I    P
// SFT  Q    C    D    V        X    H    K    Z    SFT  
//           CTL  TAB  SPC      RET  ALT  GUI


TAB SPC RET

		// Base layer (Colemak-DH)

		base_layer {
			display-name = "Base";	
			bindings = <

&kp ESC   &kp L &kp W     &kp B   &kp Y     &kp J   &kp F    &kp U   &kp O   &sp BSP DEL
&kp A     &kp R &kp S     &kp T   &kp G     &kp M   &kp N    &kp E   &kp I   &kp P
&kp LSHFT &kp Q &kp C     &kp D   &kp V     &kp X   &kp H    &kp K   &kp Z   &kp RSHFT
                &kp LCTRL &kp TAB &kp SPC   &kp RET &kp LALT &kp LGUI
			>;
		};

		// Extra layer (QWERTY)

		extra_Layer {
			display-name = "Extra";
			bindings = <
&kp L			 &kp W		  &kp B			  &kp Y			  &kp J				&kp F			&kp U			 &kp O			&kp SQT		 &mt LGUI A
&mt LALT R	  &mt LCTRL S  &mt LSHFT T	  &kp G			  &kp M				&mt LSHFT N	&mt LCTRL E	 &mt LALT I	 &mt LGUI P	&kp COMMA
&lt L04 Q  &mt RALT C   &kp D			  &kp V			  &kp DOT			  &kp X			&kp H			 &kp K			&mt RALT Z	&lt L04 SLASH
								 &lt L07 ESC  &lt L0 5 SPACE  &lt L06 TAB	&lt L09 RET  &lt L08 BSPC  &lt L10 DEL
			>;
		};

		// Tap layer (Colemak-DH without mods)

		tap_layer {
			display-name = "Tap";
			bindings = <
&kp L  &kp W  &kp B	&kp Y	  &kp J	  &kp F	&kp U	 &kp O	  &kp SQT  &kp A
&kp R  &kp S  &kp T	&kp G	  &kp M	  &kp N	&kp E	 &kp I	  &kp P	&kp COMMA
&kp Q  &kp C  &kp D	&kp V	  &kp DOT	&kp X	&kp H	 &kp K	  &kp Z	&kp SLASH
			  &kp ESC  &kp SPACE  &kp TAB	&kp RET  &kp BSPC  &kp DEL
			>;
		};

		// Button layer

		button_layer {
			display-name = "Button";
			bindings = <
&kp K_CUT   &kp K_COPY  &kp K_PASTE  &kp K_AGAIN  &kp K_AGAIN	&kp K_PASTE  &kp K_COPY   &kp K_CUT   &kp K_UNDO  &kp LGUI
&kp LALT	&kp LCTRL   &kp LSHFT	&none		&none		  &kp LSHFT	&kp LCTRL	&kp LALT	&kp LGUI	&kp K_UNDO
&kp K_UNDO  &kp K_CUT   &kp K_COPY   &kp K_PASTE  &kp K_AGAIN	&kp K_AGAIN  &kp K_PASTE  &kp K_COPY  &kp K_CUT   &kp K_UNDO
						&mkp MB3	 &mkp MB1	 &mkp MB2	   &mkp MB2	 &mkp MB1	 &mkp MB3
			>;
		};

		// Nav layer

		nav_layer {
			display-name = "Nav";
			bindings = <
&u_to_L03	   &u_to_L02	 &u_to_L01	  &u_bootloader				 &kp K_AGAIN	   &kp K_PASTE	   &kp K_COPY		&kp K_CUT		
&u_bootloader &kp LGUI		  &kp LALT		  &kp LCTRL		 &kp LSHFT		 &none			 &u_caps_word &kp LEFT		  &kp DOWN		  &kp UP			&kp RIGHT		 &kp K_UNDO
	&none			 &kp RALT		  &u_to_L08	   &u_to_L0 5	   &none			 &kp INS		   &kp HOME		  &kp PG_DN		 &kp PG_UP		 &kp END
						&none			 &none			 &none			 &kp RET		   &kp BSPC		  &kp DEL
			>;
		};

		// Mouse layer

		mouse_layer {
			display-name = "Mouse";
			bindings = <
&u_to_L03	   &u_to_L02	 &u_to_L01	  &u_bootloader				 &kp K_AGAIN	   &kp K_PASTE	   &kp K_COPY		&kp K_CUT		
&u_bootloader &kp LGUI		  &kp LALT		  &kp LCTRL		 &kp LSHFT		 &none			 &none &mmv MOVE_LEFT	&mmv MOVE_DOWN	&mmv MOVE_UP	  &mmv MOVE_RIGHT   &kp K_UNDO
	&none			 &kp RALT		  &u_to_SYM_L	   &u_to_L06	 &none			 &none			 &msc SCRL_LEFT	&msc SCRL_DOWN	&msc SCRL_UP	  &msc SCRL_RIGHT
						&none			 &none			 &none			 &mkp MB2		  &mkp MB1		  &mkp MB3
			>;
		};

		// Media layer

		media_layer {
			display-name = "Media";
			bindings = <
&u_to_L03	   &u_to_L02	 &u_to_L01	  &u_bootloader				 &none			 &none			 &none			 &none			
&u_bootloader &kp LGUI		  &kp LALT		  &kp LCTRL		 &kp LSHFT		 &none			 &none &kp C_PREV		&kp C_VOL_DN	  &kp C_VOL_UP	  &kp C_NEXT		&none
	&none			 &kp RALT		  &u_to_L10	   &u_to_L07	 &none			 &u_out_tog		&u_bt_sel_0	   &u_bt_sel_1	   &u_bt_sel_2	   &u_bt_sel_3
						&none			 &none			 &none			 &kp C_STOP		&kp C_PP		  &kp C_MUTE
			>;
		};

		// Num layer

		num_layer {
			display-name = "Num";
			bindings = <
&kp N7			&kp N8			&kp N9			&kp RBKT					  &none			 &u_to_L01	  &u_to_L02	 &u_to_L03	  
&kp LBKT &kp SEMI		  &kp N4			&kp N5			&kp N6			&kp EQUAL		 &none &kp LSHFT		 &kp LCTRL		 &kp LALT		  &kp LGUI		  &u_bootloader
	&kp GRAVE		 &kp N1			&kp N2			&kp N3			&kp BSLH		  &none			 &u_to_L08	   &u_to_L0 5	   &kp RALT		  &none
						&kp DOT		   &kp N0			&kp MINUS		 &none			 &none			 &none
			>;
		};

		// Sym layer

		sym_layer {
			display-name = "Sym";
			bindings = <
&kp AMPS		  &kp ASTRK		 &kp LPAR		  &kp RBRC					  &none			 &u_to_L01	  &u_to_L02	 &u_to_L03	  
&kp LBRC &kp COLON		 &kp DLLR		  &kp PRCNT		 &kp CARET		 &kp PLUS		  &none &kp LSHFT		 &kp LCTRL		 &kp LALT		  &kp LGUI		  &u_bootloader
	&kp TILDE		 &kp EXCL		  &kp AT			&kp HASH		  &kp PIPE		  &none			 &u_to_SYM_L	   &u_to_L06	 &kp RALT		  &none
						&kp LPAR		  &kp RPAR		  &kp UNDER		 &none			 &none			 &none
			>;
		};

		// Fun layer

		fun_layer {
			display-name = "Fun";
			bindings = <
&kp F7   &kp F8  &kp F9	 &kp PSCRN  &none			  &to L01  &to L02  &to L03	&kp F12   &kp F11
&kp F4   &kp F5  &kp F6	 &kp SLCK   &none			  &kp LSHFT   &kp LCTRL	&kp LALT	 &kp LGUI  &bootloader
&kp F10  &kp F1  &kp F2	 &kp F3	 &kp PAUSE_BREAK	&none	   &to L10	&to L07  &kp RALT  &none
				 &kp K_APP  &kp SPACE  &kp TAB			&none	   &none		&none
			>;
		};

		layer_10 {
			bindings = <
&trans  &trans  &trans  &trans  &trans	&trans  &trans  &trans  &trans  &trans
&trans  &trans  &trans  &trans  &trans	&trans  &trans  &trans  &trans  &trans
&trans  &trans  &trans  &trans  &trans	&trans  &trans  &trans  &trans  &trans
				&trans  &trans  &trans	&trans  &trans  &trans
&kp F7			&kp F8			&kp F9			&kp PSCRN					 &none			 &u_to_L01	  &u_to_L02	 &u_to_L03	  
&kp F12 &kp F11		   &kp F4			&kp F5			&kp F6			&kp SLCK		  &none &kp LSHFT		 &kp LCTRL		 &kp LALT		  &kp LGUI		  &u_bootloader
	&kp F10		   &kp F1			&kp F2			&kp F3			&kp PAUSE_BREAK   &none			 &u_to_L10	   &u_to_L07	 &kp RALT		  &none
						&kp K_APP		 &kp SPACE		 &kp TAB		   &none			 &none			 &none
			>;
		};
	};
};
